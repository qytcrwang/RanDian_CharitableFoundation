<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include :: header"></head>
<body>
<div class="layui-row">
  <div class="layui-col-md8 layui-col-md-offset2">
    <div class="dTable" style="padding-top: 10px">
      <div class="layui-inline">
        <input class="layui-input" name="id" placeholder="会员名称" id="userName" autocomplete="off"
               style="width: 200px">
      </div>
      <button class="layui-btn" data-type="reload">搜索</button>
    </div>
  </div>
</div>
<table class="layui-hide" id="contriInfoList" lay-filter="tableFilter"></table>
<script type="text/javascript">
layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element'], function () {
  var layer = layui.layer //弹层
      , table = layui.table //表格
      , element = layui.element; //元素操作
  //监听Tab切换
  element.on('tab(demo)', function (data) {
    layer.msg('切换了：' + this.innerHTML);
    console.log(data);
  });
  //执行一个 table 实例
  table.render({
    elem: '#contriInfoList'
    , url: '/back/contriInfo/contriInfoList'
    , method: 'post'
    , contentType: 'application/json'
    , page: true //开启分页
    , parseData: function (res) { //res 即为原始返回的数据
      return {
        "code": res.status, //解析接口状态
        "msg": res.message, //解析提示文本
        "data": res.data, //解析数据列表
        "count": res.count
      };
    }
    , response: {
      statusCode: 1 //规定成功的状态码，默认：0
    }
    , cols: [
      [
        {type: 'checkbox'}
        // , {title: '序号', type: 'numbers', align: 'center'}
        , {title: '捐赠金额', field: 'contriAmount', align: 'center'}
        , {title: '捐赠物品', field: 'contriThings', align: 'center'}
        , {title: '联系方式', field: 'mobile', align: 'center'}
        , {
          title: '捐赠时间', field: 'contriTime', align: 'center', templet: function (row) {
            return createTime(row.contriTime * 1000);
          }
        }
        , {
          title: '最后操作时间', field: 'updateTime', align: 'center', templet: function (row) {
            return createTime(row.updateTime * 1000);
          }
        }
        , {title: '捐赠状态', field: 'contriState', align: 'center', templet: '#titleTpl'}
        , {fixed: 'right', width: 165, align: 'center', toolbar: '#bar'}
      ]
    ]
    , id: 'tableReload'
  });

  //监听工具条
  table.on('tool(tableFilter)', function (obj) {
    var data = obj.data //获得当前行数据
        , layEvent = obj.event; //获得 lay-event 对应的值
    if (layEvent === 'detail') {
      // layer.msg('查看操作');
      var jsonData;
      $.ajax({
        type: "get",
        url: "/back/contriInfo/getContriInfoDetail",
        dataType: "json",
        data: {"userName": data.userName},
        success: function (data) {
          jsonData = data.data;
        }
      });
      layer.open({
        type: 2
        , offset: '0px'
        , scrollbar: false
        , title: '捐赠详情'
        , skin: 'layui-layer-molv'
        , area: ['1000px', '450px']
        , content: ['/contriInfoDetail', 'false']
        , success: function (layero, index) {
          console.log(layero, index);
          var name = $("#nameIndex", layero.find("iframe")[0].contentWindow.document);
          name.val(jsonData.contriAmount);
        }
      });
    } else if (layEvent === 'edit') {
      layer.confirm('是否确认审核通过？', function(index){
        offset: '200px';
        layer.close(index);
        $.ajax({
          type:"post",
          contentType: 'application/json',
          url:"/back/contriInfo/updateContriStatus",
          dataType:"json",
          data: JSON.stringify({
            id:data.id, contriState:1
          }),
          // beforeSend: function () {
          //   //禁用按钮防止重复提交
          //   $("#submit").attr({ disabled: "disabled" });
          // },
          success: function (data) {
            if (data.status === 1) {
              layer.msg("认证成功", {
                icon: 1,
                success: location.reload()
              });
            }
            else {
              layer.msg(data.msg);
            }
          },
        });
      });
    }
  });

  var $ = layui.$, active = {
    reload: function () {
      var userName = $('#userName');
      //执行重载
      table.reload('tableReload', {
        page: {
          curr: 1 //重新从第 1 页开始
        }
        , where: {
          userName: userName.val()
        }
      });
    }
  };

  $('.dTable .layui-btn').on('click', function () {
    var type = $(this).data('type');
    active[type] ? active[type].call(this) : '';
  });
});
</script>
  <script type="text/html" id="bar">
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">详情</a>
  <a class="layui-btn layui-btn-xs" lay-event="edit">审核</a>
</script>

<script type="text/html" id="titleTpl">
  {{#if (d.contriState == 0) { }}
  <span>待证实</span>
  {{# }else if(d.contriState == 1){ }}
  <span>已证实</span>
  {{# } }}
</script>

<script type="text/javascript">
/**13位时间戳转换成 年月日 上午 时间  2018-05-23 10:41:08 */
function createTime(v) {
  return new Date(parseInt(v)).toLocaleString()
}

/**重写toLocaleString方法*/
Date.prototype.toLocaleString = function () {
  var y = this.getFullYear();
  var m = this.getMonth() + 1;
  m = m < 10 ? '0' + m : m;
  var d = this.getDate();
  d = d < 10 ? ("0" + d) : d;
  var h = this.getHours();
  h = h < 10 ? ("0" + h) : h;
  var M = this.getMinutes();
  M = M < 10 ? ("0" + M) : M;
  var S = this.getSeconds();
  S = S < 10 ? ("0" + S) : S;
  return y + "-" + m + "-" + d + " " + h + ":" + M + ":" + S;
};
</script>
</body>
