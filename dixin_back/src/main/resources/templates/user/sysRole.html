<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include :: header">
</head>
<body>
<form class="layui-form" id="searchForm">
  <div class="layui-row" style="text-align: center">
    <div class="layui-col-md12" style="padding: 20px">
        权限名称：
      <div class="layui-inline">
        <input class="layui-input" name="roleName" id="roleName" autocomplete="off">
      </div>
        权限字符：
      <div class="layui-inline">
        <input class="layui-input" name="roleKey" id="roleKey" autocomplete="off">
      </div>
      角色状态：
      <div class="layui-inline">
        <select name="status" lay-filter="status" id="status">
          <option value="" selected>全部</option>
          <option value="0">正常</option>
          <option value="1">停用</option>
        </select>
      </div>
        创建时间：
        <div class="layui-inline">
          <input type="text" class="layui-input" name="startTime" id="startTime" placeholder="开始时间" onfocus="noInput(this)">
        </div>-
        <div class="layui-inline">
          <input type="text" class="layui-input" name="endTime" id="endTime" placeholder="截止时间" onfocus="noInput(this)">
        </div>
        <div class="layui-inline" style="float:right;">
          <button type="button" class="layui-btn" data-type="reload" id="search">搜索</button>
          <button type="button" class="layui-btn layui-btn-primary" data-type="reload" id="clear">重置</button>
          <button type="button" class="layui-btn" data-type="reload" id="add"><i class="layui-icon">&#xe608;</i>新增</button>
        </div>
    </div>
  </div>
</form>
  <table class="layui-hide" id="demoTable" lay-filter="tableFilter"></table>

<!--弹出框-->
<form class="layui-form layui-form-pane" id="sysRoleInfo" style="display:none;padding:40px;">
  <input type="hidden" name="roleId" id="_roleId">
  <div class="layui-form-item" style="padding-top: 10px">
    <label class="layui-form-label is-required">角色名称</label>
    <div class="layui-input-block">
      <input type="text" name="roleName" id="_roleName"   placeholder="请输入角色名称" class="layui-input" >
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label is-required">权限字符</label>
    <div class="layui-input-block">
      <input type="text" name="roleKey" id="_roleKey" required  placeholder="请输入权限字符" class="layui-input" >
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label is-required">显示顺序</label>
    <div class="layui-input-block">
      <input type="text" name="roleSort" id="_roleSort" required  placeholder="请输入显示顺序" class="layui-input" >
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">状态</label>
    <div class="layui-input-block">
      <input type="checkbox" id="_status" name="status" lay-skin="switch" checked>
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">备注</label>
    <div class="layui-input-block">
      <input type="text" name="remark" id="_remark"  placeholder="请输入备注信息" class="layui-input" >
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">菜单权限</label>
    <div class="layui-col-md6"><div id="menuTrees"></div></div>

  </div>
</form>
  <script type="text/javascript">

    let tableIns;
    //加载下拉框
    layui.use(['laydate', 'laypage', 'layer', 'table', 'tree','util','form'], function(){
      let layer = layui.layer, //弹层
          table = layui.table, //表格
          laydate = layui.laydate, //元素操作
          form = layui.form;
      //执行一个 table 实例
      tableIns = table.render({
        elem: '#demoTable'
        ,url: '/back/sysRole/list'
        ,method: 'post'
        ,contentType: 'application/json'
        ,id:'demoTable'
        ,parseData: function(res){ //res 即为原始返回的数据
          return {
            "code": res.status, //解析接口状态
            "msg": res.message, //解析提示文本
            "count": res.count, //解析数据长度
            "data": res.data //解析数据列表
          };
        }
        ,where: {}
        ,response: {
          statusCode:1 //规定成功的状态码，默认：0
        }
        ,page: true //开启分页
        ,cols: [
          [
            /*{type:'checkbox'}*/
            /*   ,{title: '序号', type:'numbers', align: 'center'}*/
            {width:'6%',field: 'roleId',  title:'角色编号', align: 'center'}
            ,{field:'roleName', title: '角色名称', align: 'center'}
            ,{field:'roleKey', title: '权限字符', align: 'center'}
            ,{field:'roleSort', title: '显示顺序', align: 'center'}
            ,{field:'status',title:'角色状态',align:'center',templet:'#checkboxS'}
            ,{field:'createTime', title: '创建时间', align: 'center',templet:function(d){
              return  layui.util.toDateString(d.createTime,"yyyy-MM-dd HH:mm:ss");
            }}
            ,{width:'15%', title: '操作', align:'center', toolbar: '#bar'}
          ]
        ]
      });
      //常规用法
      laydate.render({
        elem: '#startTime'
        ,trigger: 'click'
      });
      laydate.render({
        elem: '#endTime'
        ,trigger: 'click'
      });
      $("#add").bind("click", function() {
        $("#sysRoleInfo").clearForm();
        $("#_roleId").val("");
        initTree();
        openLayer('新建角色','/back/sysRole/add',0);
      });
      /*ESC关闭弹窗*/
      $(document).ready(function () { }).keydown(
              function (e) {
                if (e.which === 27) {
                  layer.closeAll();
                }
              });
      $("#search").bind("click", function() {
        searchForm();
      });
      form.on('select(status)', function(data){
        searchForm();
      });
      $("#clear").bind("click", function() {
        $("#searchForm").clearForm();
        searchForm();
      });
      form.on('switch(release)', function(obj){
        let data={roleId:obj.value,status:obj.elem.checked?0:1}
        saveData("/back/sysRole/stopUsing",data);
        layer.closeAll();
      });

      form.on('submit(formDemo)', function(data){
        return false;
      });
      table.on('tool(tableFilter)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
        let data = obj.data; //获得当前行数据
        let layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
        if(layEvent === 'edit'){ //编辑
          getEditData(data['roleId']);
          initTree(data['roleId']);
          openLayer('编辑管理员信息','/back/sysRole/update',1);
        }else if(layEvent === 'del'){ //删除
          layer.confirm('确认要删除吗', {icon: 3, title:'信息删除确认'}, function(index){
            saveData("/back/sysRole/del",{roleId:data['roleId']})
          });
        }else if(layEvent==='toAuthUser'){
            location.href="/back/sysRole/toAuthUser?roleId="+data['roleId'];
        }
      });

    });
    function saveData(url,data){
      $.ajax({
        type : "post",
        url : url,
        data : JSON.stringify(data),
        headers : {
          'Content-Type' : 'application/json;charset=utf-8'
        },
        dataType : 'json',
        error : function(XMLHttpRequest, textStatus, errorThrown) {
          console.log(XMLHttpRequest.status + "," + XMLHttpRequest.readyState + ","
                  + textStatus + "," + errorThrown);
        },
        success : function(result) {
          if(result["status"] == 1){
            layer.closeAll();
            layer.msg(result["msg"]);

          }else{
            layer.alert(result["msg"]);
          }
          searchForm();
        }
      });
    }

    function getEditData(data){
      //获取行
      /*layui.use('table', function(){
      let table = layui.table;
      let checkData = table.checkStatus('demoTable').data;
     if(checkData.length != 1){
          layer.msg('请选择一行数据！');
          return;
     }
     let id = checkData[0]["id"];*/
      $("#sysRoleInfo").clearForm();
      $.ajax({
        type : "post",
        url : "/back/sysRole/getById",
        data : JSON.stringify({"roleId":data}),
        headers : {
          'Content-Type' : 'application/json;charset=utf-8'
        },
        dataType : 'json',
        error : function(XMLHttpRequest, textStatus, errorThrown) {
          console.log(XMLHttpRequest.status + "," + XMLHttpRequest.readyState + ","
                  + textStatus + "," + errorThrown);
        },
        success : function(result) {
          if(result["status"] == 1) {
            let data = result["data"];
            $("#_roleId").val(data["roleId"]);
            $("#_roleKey").val(data["roleKey"]);
            $("#_roleName").val(data['roleName'])
            $("#_roleSort").val(data["roleSort"]);
            $("#_remark").val(data["remark"]);
            if (data['status'] == 0) {
              $("#_status").prop('checked', true);
            } else {
              $("#_status").removeAttr('checked');
            }
            layui.use(['form'], function () {
              layui.form.render("checkbox");
            });
          }else{
            layui.alert(result['msg']);
          }
        }
      });
    }

    function openLayer(titleName,url,type){
      layer.open({
        type:1,
        area:['800px','800px'],
        title: titleName
        ,content: $("#sysRoleInfo"),
        shade: 0.3,
        resize:false ,
        moveType: 1,//可拖动
        moveOut: true,//可拖动移出
        shadeClose:true,//点击遮罩关闭弹窗
        btn: ['提交', '返回']
        ,btn1: function(index, layero){
          if(!inputValidate(type))
            return;
          let data =getparams(type);
          let menuIds = getCheckedIds(layui.tree.getChecked('demoId1'));
          data.menuIds = menuIds;
          saveData(url,data);
        },
        btn2: function(index, layero){
          layer.closeAll();
        },
        cancel: function(layero,index){
          layer.closeAll();
        }
      });
    }
    function searchForm(){
      layui.use('table', function(){
        let roleName = $("#roleName").val();
        let roleKey = $("#roleKey").val();
        let status = $("#status").val();
        let startTime = $("#startTime").val();
        let endTime = $("#endTime").val();
        if(startTime!=""&&endTime!=""){
          if(startTime>endTime){
            layer.msg('时间起始不可大于时间截止！');
            $("#endTime").val("");
            return;
          }
        }
        let table = layui.table;
        table.reload('demoTable',{
          where: {roleName:roleName,roleKey:roleKey,
            status:status,startTime:startTime,
            endTime:endTime}
          ,page: {
            curr: 1 //重新从第 1 页开始
          }
        });
      });
    }
    //让时间插件无法选中 达到禁止手输的目的
    function noInput(dom){
      $(dom).blur();
    }

    function getparams(type){
      //type==0 ==>新增 type==1 ==>编辑
      let o = {};
      o.roleName = $.trim($("#_roleName").val());
      o.roleKey = $.trim($("#_roleKey").val());
      o.roleSort = $.trim($("#_roleSort").val());
      if(type==1){
        o.roleId = $.trim($("#_roleId").val());
      }
      o.remark = $.trim($("#_remark").val());
      o.status=$("#_status").prop("checked")?0:1
      return o;

    }
    function inputValidate(type){
      //type==0 ==>新增 type==1 ==>编辑
      let _roleName = $.trim($("#_roleName").val());
      if(_roleName=="") {
        layer.msg("角色名称不可为空");
        return false;
      }
      let _roleKey = $.trim($("#_roleKey").val());
      if(_roleKey=="") {
        layer.msg("角色字符不可为空");
        return false;
      }
      let _roleSort = $.trim($("#_roleSort").val());
      if(_roleSort=="") {
        layer.msg("显示顺序不可为空");
        return false;
      }
      return true;
    }
    /**
     * 自动将form表单封装成json对象
     */
    $.fn.serializeObject = function() {
      let o = {};
      let a = this.serializeArray();
      $.each(a, function() {
        if (o[this.name]) {
          if (!o[this.name].push) {
            o[this.name] = [ o[this.name] ];
          }
          o[this.name].push(this.value || '');
        } else {
          o[this.name] = this.value || '';
        }
      });
      return o;
    };
  function initTree(roleId){
    $("#menuTrees").html("");
      $.ajax({
        url:"/back/sysRole/roleMenuTreeData",
        type:"get",
        data:{roleId:roleId},
        success:function(data){
          layui.use(["tree","util"],function(){
            layui.tree.render({
              elem: '#menuTrees'
              ,data: data
              ,showCheckbox: true  //是否显示复选框
              ,id: 'demoId1'
              ,isJump: false //是否允许点击节点时弹出新窗口跳转
              ,
            });
          });
        }
      });
  }
  function getCheckedIds(nodes){
    let ids = [];
    getChecked(nodes);
    function getChecked(data){
      $.each(data,function(index,value){
          ids.push(value['id']);
          if(value['children']){
            getChecked(value['children']);
          }
      });
    }
    return ids;
  }
  </script>
  <script type="text/html" id="bar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="toAuthUser">分配用户</a>
  </script>
  <script id="checkboxS" type="text/html">
    <!-- 这里的 checked 的状态只是演示 -->
    <input type="checkbox" value="{{d.roleId}}" lay-skin="switch" lay-text="开启|停用" lay-filter="release" {{ d.status == 0 ? 'checked' : '' }}>
  </script>
</body>
