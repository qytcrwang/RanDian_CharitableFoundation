<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="include :: header">
</head>
<body>
<form class="layui-form" id="searchForm">
    <div class="layui-row" style="text-align: center">
        <div class="layui-col-md12" style="padding:20px;">
            登录名称：
            <div class="layui-inline">
                <input class="layui-input" name="loginName" id="loginName" autocomplete="off">
            </div>
            手机号码：
            <div class="layui-inline">
                <input class="layui-input" name="phonenumber" id="phonenumber" autocomplete="off">
            </div>
            用户状态：
            <div class="layui-inline">
                <select name="status" lay-filter="status" id="status">
                    <option value="" selected>全部</option>
                    <option value="0">正常</option>
                    <option value="1">停用</option>
                </select>
            </div>
            创建时间：
            <div class="layui-inline">
                <input type="text" class="layui-input" name="startTime" id="startTime" placeholder="开始时间起始" onfocus="noInput(this)">
            </div>-
            <div class="layui-inline">
                <input type="text" class="layui-input" name="endTime" id="endTime" placeholder="开始时间截止" onfocus="noInput(this)">
            </div>
            <div class="layui-inline" style="float:right;">
                <button type="button" class="layui-btn" data-type="reload" id="search">搜索</button>
                <button type="button" class="layui-btn layui-btn-primary" data-type="reload" id="clear">重置</button>
                <button type="button" class="layui-btn" data-type="reload" id="add"><i class="layui-icon">&#xe608;</i>新增</button>
            </div>
        </div>
    </div>
</form>
<table class="layui-hide" id="demoTable" lay-filter="tableFilter"></table>

<!--弹出框-->
<form class="layui-form layui-form-pane" id="sysUserInfo" style="display:none">
    <input type="hidden" name="userId" id="_userId">
    <div class="layui-form-item" style="padding-top: 10px">
        <label class="layui-form-label is-required">用户名称</label>
        <div class="layui-input-block">
            <input type="text" name="userName" id="_userName"   lay-verify="required" placeholder="请输入登录名称" class="layui-input required" >
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label is-required">手机号码</label>
        <div class="layui-input-block">
            <input type="text" name="phonenumber" id="_phonenumber" required lay-verify="required" placeholder="请输入手机号码" class="layui-input required" >
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label is-required">登录名称</label>
        <div class="layui-input-block">
            <input type="text" name="loginName" id="_loginName" required  lay-verify="required" placeholder="请输入登录名称" class="layui-input required" >
        </div>
    </div>
    <div class="layui-form-item" id="_pass">
        <label class="layui-form-label is-required">登录密码</label>
        <div class="layui-input-block">
            <input type="password" name="password" id="_password" required  lay-verify="required" placeholder="请输入登录密码" class="layui-input required" >
        </div>
    </div>
    <div class="layui-form-item ">
        <label class="layui-form-label">用户性别</label>
        <div class="layui-input-block">
            <select name="sex" id="_sex">
                <option value="0" selected>男</option>
                <option value="1">女</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label is-required">邮箱</label>
        <div class="layui-input-block">
            <input type="text" name="email" id="_email" required  lay-verify="required" placeholder="请输入邮箱" class="layui-input required" >
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">用户状态</label>
        <div class="layui-input-block">
            <input type="checkbox" id="_status" name="status" lay-skin="switch" checked>
        </div>
    </div>
</form>
<form class="layui-form layui-form-pane" id="reset" style="display:none">
    <input type="hidden" name="userId" id="_resetUserId">
    <div class="layui-form-item">
        <label class="layui-form-label is-required">登录名称</label>
        <div class="layui-input-block">
            <input type="text" id="_userLoginName" readonly  class="layui-input required" >
        </div>
    </div>
    <div class="layui-form-item" >
        <label class="layui-form-label is-required">新密码</label>
        <div class="layui-input-block">
            <input type="password" name="password" id="_newPassword" required  placeholder="请输入登录密码" class="layui-input required" >
        </div>
    </div>
    <div class="layui-form-item" >
        <label class="layui-form-label is-required">重新密码</label>
        <div class="layui-input-block">
            <input type="password" id="_repeatPassword" required  placeholder="请输入登录密码" class="layui-input required" >
        </div>
    </div>
</form>
<script type="text/javascript">
    let tableIns;
    //加载下拉框
    layui.use(['laydate', 'laypage', 'layer', 'table', 'form'], function(){
        let layer = layui.layer //弹层
            ,table = layui.table //表格
            ,form = layui.form,
            laydate = layui.laydate; //元素操作
        //执行一个 table 实例
        tableIns = table.render({
            elem: '#demoTable'
            ,url: '/back/sysUser/list'
            ,method: 'post'
            ,contentType: 'application/json'
            ,id:'demoTable'
            ,parseData: function(res){ //res 即为原始返回的数据
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.message, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.data //解析数据列表
                };
            }
            ,where: {}
            ,response: {
                statusCode:1 //规定成功的状态码，默认：0
            }
            ,page: true //开启分页
            ,cols: [
                [
                    /*{type:'checkbox'}*/
                    /*   ,{title: '序号', type:'numbers', align: 'center'}*/
                    {width:'6%',field: 'userId',  title:'用户编号', align: 'center'}
                    ,{field:'loginName', title: '登录名称', align: 'center'}
                    ,{field:'userName', title: '用户昵称', align: 'center'}
                    ,{field:'phonenumber', title: '手机号码', align: 'center'}
                    ,{field:'status',title:'用户状态',align:'center',templet:'#checkboxS'}
                    ,{field:'createTime', title: '创建时间', align: 'center',templet:function(d){
                        return  layui.util.toDateString(d.createTime,"yyyy-MM-dd HH:mm:ss");
                    }}
                    ,{width:'15%', title: '操作', align:'center', toolbar: '#bar'}
                ]
            ]
        });
        //常规用法
        laydate.render({
            elem: '#startTime'
            ,trigger: 'click'
        });
        laydate.render({
            elem: '#endTime'
            ,trigger: 'click'
        });
        $("#add").bind("click", function() {
            $("#sysUserInfo").clearForm();
            $("#_userId").val("");
            $("#_loginName").removeAttr("readonly");
            $('#_pass').show();
            openLayer('新建管理员','/back/sysUser/add',0);
        });

        $("#search").bind("click", function() {
            searchForm();
        });

        $("#clear").bind("click", function() {
            $("#searchForm").clearForm();
            searchForm();
        });
        form.on('switch(release)', function(obj){
            let data={userId:obj.value,status:obj.elem.checked?0:1}
            saveData("/back/sysUser/update",data);
            layer.closeAll();
        });
        /*ESC关闭弹窗*/
        $(document).ready(function () { }).keydown(
            function (e) {
                if (e.which === 27) {
                    layer.closeAll();
                }
            });

        form.on('select(status)', function(data){
            searchForm();
        });
        form.on('submit(formDemo)', function(data){
            //layer.msg(JSON.stringify(data.field));
            return false;
        });
        table.on('tool(tableFilter)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            let data = obj.data; //获得当前行数据
            let layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            if(layEvent === 'edit'){ //编辑
                $('#_pass').hide();
                getEditData(data['userId']);
                openLayer('编辑管理员信息','/back/sysUser/update',1);
            }else if(layEvent === 'del'){ //删除
                layer.confirm('确认要删除吗', {icon: 3, title:'信息删除确认'}, function(index){
                    saveData("/back/sysUser/del",{userId:data['userId']});
                });
            }else if(layEvent==='reset'){
                reset(data['userId'],data['loginName']);
            }
        });

    });
    function reset(userId,loginName){
        $("#reset").clearForm();
        $("#_resetUserId").val(userId);
        $("#_userLoginName").val(loginName);
        layer.open({
            type:1,
            area:['600px','300px'],
            title: "重置密码"
            ,content: $("#reset"),
            shade: 0.3,
            resize:false ,
            move: false,
            btn: ['重置', '返回']
            ,btn1: function(index, layero){
                resetPassword();
            },
            btn2: function(index, layero){
                layer.closeAll();
            },
            cancel: function(layero,index){
                layer.closeAll();
            }
        });
    }
    function resetPassword(){
        let userId =  $("#_resetUserId").val();
        let password = $("#_newPassword").val();
        let passwordRepeat = $("#_repeatPassword").val();
        if(userId==""){
            layer.msg("参数异常，请刷新再试");
            return;
        }
        if(password==""){
            layer.msg("请输入新密码");
            return;
        }
        if(password!=passwordRepeat){
            layer.msg("两次输入密码不一致")
            return;
        }
        $.ajax({
            type:"post",
            url:"/back/sysUser/reset",
            data : JSON.stringify({userId:userId,password,password}),
            headers : {
                'Content-Type' : 'application/json;charset=utf-8'
            },
            dataType : 'json',
            success:function(data){
                if(data["status"] == 1){
                    layer.msg(data["msg"]);
                    layer.closeAll();
                }else{
                    layer.alert(data['msg']);
                }
            }
        });
    }
    function saveData(url,data){
        $.ajax({
            type : "post",
            url : url,
            data : JSON.stringify(data),
            headers : {
                'Content-Type' : 'application/json;charset=utf-8'
            },
            dataType : 'json',
            error : function(XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status + "," + XMLHttpRequest.readyState + ","
                    + textStatus + "," + errorThrown);
            },
            success : function(result) {
                if(result["status"] == 1){
                    layer.closeAll();
                    layer.msg(result["msg"]);
                    searchForm();
                }else{
                    layer.alert(result['msg']);
                }
            }
        });
    }

    function getEditData(data){
        //获取行
        /*layui.use('table', function(){
        let table = layui.table;
        let checkData = table.checkStatus('demoTable').data;
       if(checkData.length != 1){
            layer.msg('请选择一行数据！');
            return;
       }
       let id = checkData[0]["id"];*/
        $("#sysUserInfo").clearForm();
        $.ajax({
            type : "post",
            url : "/back/sysUser/getUserInfo",
            data : JSON.stringify({"userId":data}),
            headers : {
                'Content-Type' : 'application/json;charset=utf-8'
            },
            dataType : 'json',
            error : function(XMLHttpRequest, textStatus, errorThrown) {
                console.log(XMLHttpRequest.status + "," + XMLHttpRequest.readyState + ","
                    + textStatus + "," + errorThrown);
            },
            success : function(result) {
                if(result['status']==1) {
                    let data = result["data"];
                    $("#_userId").val(data["userId"]);
                    $("#_loginName").val(data["loginName"]);
                    $("#_loginName").attr("readonly", "readonly");
                    $("#_phonenumber").val(data["phonenumber"]);
                    $("#_userName").val(data["userName"]);
                    $("#_email").val(data["email"]);
                    let sex = data['sex'];
                    let status = data['status'];
                    $("#_sex").val(sex);
                    if (status == 0) {
                        $("#_status").prop('checked', true);
                    } else {
                        $("#_status").removeAttr('checked');
                    }
                    layui.use(['form'], function () {
                        layui.form.render("checkbox");
                        layui.form.render("select");
                    });
                }else{
                    layui.alert(result['msg']);
                }
            }
        });
    }

    function openLayer(titleName,url,type){
        layer.open({
            type:1,
            area:['800px','480px'],
            title: titleName
            ,content: $("#sysUserInfo"),
            shade: 0.3,
            resize:false ,
            moveType:1,
            moveOut:true,
            btn: ['提交', '返回']
            ,btn1: function(index, layero){
                if(!inputValidate(type))
                    return;
                let data =getparams(type);
                saveData(url,data);
            },
            btn2: function(index, layero){
                layer.closeAll();
            },
            cancel: function(layero,index){
                layer.closeAll();
            }
        });
    }
    function searchForm(){
        layui.use('table', function(){
            let loginName = $("#loginName").val();
            let phonenumber = $("#phonenumber").val();
            let status = $("#status").val();
            let startTime = $("#startTime").val();
            let endTime = $("#endTime").val();
            if(startTime!=""&&endTime!=""){
                if(startTime>endTime){
                    layer.msg('时间起始不可大于时间截止！');
                    $("#endTime").val("");
                    return;
                }
            }
            let table = layui.table;
            table.reload('demoTable',{
                where: {loginName:loginName,phonenumber:phonenumber,
                    status:status,startTime:startTime,
                    endTime:endTime}
                ,page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        });
    }
    //让时间插件无法选中 达到禁止手输的目的
    function noInput(dom){
        $(dom).blur();
    }

    function getparams(type){
        //type==0 ==>新增 type==1 ==>编辑
        let o = {};
        o.userName = $.trim($("#_userName").val());
        o.phonenumber = $.trim($("#_phonenumber").val());
        o.loginName = $.trim($("#_loginName").val());
        if(type==0)
            o.password = $.trim($("#_password").val());
        else if(type==1){
            o.userId = $.trim($("#_userId").val());
        }
        o.email = $.trim($("#_email").val());
        o.status=$("#_status").prop("checked")?0:1
        return o;

    }
    function inputValidate(type){
        //type==0 ==>新增 type==1 ==>编辑
        let _userName = $.trim($("#_userName").val());
        if(_userName=="") {
            layer.msg("用户姓名不可为空");
            return false;
        }
        let _phonenumber = $.trim($("#_phonenumber").val());
        if(_phonenumber=="") {
            layer.msg("手机号码不可为空");
            return false;
        }
        let _loginName = $.trim($("#_loginName").val());
        if(_loginName=="") {
            layer.msg("登录名称不可为空");
            return false;
        }
        if(type==0) {
            let _password = $.trim($("#_password").val());
            if (_password == "") {
                layer.msg("密码不可为空");
                return false;
            }
        }
        let _email = $.trim($("#_email").val());
        if(_email=="") {
            layer.msg("邮箱不可为空");
            return false;
        }
        return true;
    }
    /**
     * 自动将form表单封装成json对象
     */
    $.fn.serializeObject = function() {
        let o = {};
        let a = this.serializeArray();
        $.each(a, function() {
            if (o[this.name]) {
                if (!o[this.name].push) {
                    o[this.name] = [ o[this.name] ];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };
</script>
<script type="text/html" id="bar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="reset">重置</a>
</script>
<script id="checkboxS" type="text/html">
    <!-- 这里的 checked 的状态只是演示 -->
    <input type="checkbox" value="{{d.userId}}" lay-skin="switch" lay-text="开启|停用" lay-filter="release" {{ d.status == 0 ? 'checked' : '' }}>
</script>
</body>
